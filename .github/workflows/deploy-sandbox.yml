name: ðŸš€ Deploy to Sandbox

on:
  push:
    branches: [sandbox]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/komuu-frontend
  DROPLET_HOST: ${{ secrets.DROPLET_HOST }}
  DROPLET_USER: ${{ secrets.DROPLET_USER }}
  CONTAINER_NAME: nextjs-sandbox
  APP_PORT: 3003
  BACKEND_URL: https://sandbox-api.komuu.com/api/v1/
  SSH_PORT: 2222

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Verify Next.js version (CVE-2025-55182 mitigation)
        run: |
          NEXT_VERSION=$(node -p "require('./package-lock.json').packages['node_modules/next'].version" 2>/dev/null || echo "unknown")
          echo "Next.js version: $NEXT_VERSION"
          
          # Fail if vulnerable version detected
          if [[ "$NEXT_VERSION" =~ ^15\.[0-4]\. ]] || [[ "$NEXT_VERSION" =~ ^15\.5\.[0-6]$ ]]; then
            echo "âŒ VULNERABLE Next.js version detected: $NEXT_VERSION"
            echo "Required: >= 15.5.7 for CVE-2025-55182 fix"
            exit 1
          fi
          echo "âœ… Next.js version $NEXT_VERSION is patched"

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:sandbox-${{ github.sha }}
            ${{ env.DOCKER_IMAGE }}:sandbox-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_BACKEND_API_URL=${{ env.BACKEND_URL }}
            NODE_ENV=production

      - name: ðŸš€ Deploy to Sandbox
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DROPLET_HOST }}
          username: ${{ env.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          script_stop: true
          script: |
            set -euo pipefail
            
            IMAGE="${{ env.DOCKER_IMAGE }}:sandbox-latest"
            CONTAINER="${{ env.CONTAINER_NAME }}"
            PORT="${{ env.APP_PORT }}"
            PREVIOUS_IMAGE=""
            
            echo "ðŸš€ Starting sandbox deployment..."
            echo "Image: $IMAGE"
            echo "Container: $CONTAINER"
            
            # Capture current image for rollback
            if docker inspect "$CONTAINER" &>/dev/null; then
              PREVIOUS_IMAGE=$(docker inspect --format='{{.Config.Image}}' "$CONTAINER" 2>/dev/null || true)
              echo "ðŸ“Œ Previous image: $PREVIOUS_IMAGE"
            fi
            
            # Login and pull new image
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker pull "$IMAGE"
            
            # Stop and remove old container
            docker stop "$CONTAINER" 2>/dev/null || true
            docker rm "$CONTAINER" 2>/dev/null || true
            
            # Start new container
            docker run -d \
              --name "$CONTAINER" \
              -p "${PORT}:3000" \
              -e NODE_ENV=production \
              --restart unless-stopped \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              --memory=512m \
              --cpus=1 \
              --security-opt=no-new-privileges:true \
              --read-only \
              --tmpfs /tmp:rw,noexec,nosuid,size=64m \
              "$IMAGE"
            
            # Health check with retry loop
            echo "â³ Waiting for container to be healthy..."
            MAX_RETRIES=12
            RETRY_INTERVAL=5
            
            for i in $(seq 1 $MAX_RETRIES); do
              if curl -sf --max-time 5 "http://localhost:${PORT}" > /dev/null 2>&1; then
                echo "âœ… Health check passed on attempt $i"
                break
              fi
              
              if [ $i -eq $MAX_RETRIES ]; then
                echo "âŒ Health check failed after $MAX_RETRIES attempts"
                docker logs --tail 100 "$CONTAINER"
                
                # Rollback if previous image exists
                if [ -n "$PREVIOUS_IMAGE" ] && [ "$PREVIOUS_IMAGE" != "$IMAGE" ]; then
                  echo "ðŸ”„ Rolling back to $PREVIOUS_IMAGE"
                  docker stop "$CONTAINER" 2>/dev/null || true
                  docker rm "$CONTAINER" 2>/dev/null || true
                  docker run -d \
                    --name "$CONTAINER" \
                    -p "${PORT}:3000" \
                    -e NODE_ENV=production \
                    --restart unless-stopped \
                    --log-driver json-file \
                    --log-opt max-size=10m \
                    --log-opt max-file=3 \
                    "$PREVIOUS_IMAGE"
                  echo "âš ï¸ Rolled back to previous version"
                fi
                exit 1
              fi
              
              echo "Attempt $i/$MAX_RETRIES failed, retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            done
            
            # Cleanup old images (keep last 3)
            docker image prune -f
            echo "ðŸŽ‰ Sandbox deployment completed successfully"

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Sandbox" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.DOCKER_IMAGE }}:sandbox-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY