name: ðŸš€ Deploy to Sandbox

on:
  push:
    branches: [sandbox]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/komuu-frontend
  DROPLET_HOST: ${{ secrets.DROPLET_HOST }}
  DROPLET_USER: ${{ secrets.DROPLET_USER }}
  CONTAINER_NAME: nextjs-sandbox
  INTERNAL_PORT: 3000
  BACKEND_URL: https://sandbox-api.komuu.com/api/v1/
  SSH_PORT: 2222
  DOCKER_NETWORK: komuu

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Verify Next.js version (CVE-2025-55182 mitigation)
        run: |
          NEXT_VERSION=$(node -p "require('./package-lock.json').packages['node_modules/next'].version" 2>/dev/null || echo "unknown")
          echo "Next.js version: $NEXT_VERSION"
          if [[ "$NEXT_VERSION" =~ ^15\.[0-4]\. ]] || [[ "$NEXT_VERSION" =~ ^15\.5\.[0-6]$ ]]; then
            echo "âŒ VULNERABLE Next.js version detected: $NEXT_VERSION"
            exit 1
          fi
          echo "âœ… Next.js version $NEXT_VERSION is patched"

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:sandbox-${{ github.sha }}
            ${{ env.DOCKER_IMAGE }}:sandbox-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_BACKEND_API_URL=${{ env.BACKEND_URL }}
            NODE_ENV=production

      - name: ðŸš€ Deploy to Sandbox
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DROPLET_HOST }}
          username: ${{ env.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          script_stop: true
          script: |
            set -euo pipefail
            
            IMAGE="${{ env.DOCKER_IMAGE }}:sandbox-latest"
            CONTAINER="${{ env.CONTAINER_NAME }}"
            PREVIOUS_IMAGE=""
            
            echo "ðŸš€ Starting sandbox deployment..."
            
            if docker inspect "$CONTAINER" &>/dev/null; then
              PREVIOUS_IMAGE=$(docker inspect --format='{{.Config.Image}}' "$CONTAINER" 2>/dev/null || true)
            fi
            
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker pull "$IMAGE"
            
            docker network create ${{ env.DOCKER_NETWORK }} 2>/dev/null || true
            
            docker stop "$CONTAINER" 2>/dev/null || true
            docker rm "$CONTAINER" 2>/dev/null || true
            
            docker run -d \
              --name "$CONTAINER" \
              --network ${{ env.DOCKER_NETWORK }} \
              -e NODE_ENV=production \
              --restart unless-stopped \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              --memory=512m \
              --cpus=1 \
              "$IMAGE"
            
            MAX_RETRIES=12
            for i in $(seq 1 $MAX_RETRIES); do
              if docker exec "$CONTAINER" wget -q --spider "http://localhost:${{ env.INTERNAL_PORT }}" 2>/dev/null || \
                 docker exec "$CONTAINER" curl -sf "http://localhost:${{ env.INTERNAL_PORT }}" > /dev/null 2>&1; then
                echo "âœ… Health check passed"
                break
              fi
              [ $i -eq $MAX_RETRIES ] && { docker logs --tail 100 "$CONTAINER"; exit 1; }
              sleep 5
            done
            
            docker image prune -f
            echo "ðŸŽ‰ Sandbox deployment completed"

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## Sandbox Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Network:** komuu (internal only)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY