name: ðŸš€ Deploy to Production

on:
  push:
    branches: [production]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/komuu-frontend
  DROPLET_HOST: ${{ secrets.DROPLET_HOST }}
  DROPLET_USER: ${{ secrets.DROPLET_USER }}
  CONTAINER_NAME: nextjs-production
  INTERNAL_PORT: 3000
  BACKEND_URL: https://api.komuu.com/api/v1/
  SSH_PORT: 2222
  DOCKER_NETWORK: komuu

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Verify Next.js version (CVE-2025-55182 mitigation)
        run: |
          NEXT_VERSION=$(node -p "require('./package-lock.json').packages['node_modules/next'].version" 2>/dev/null || echo "unknown")
          echo "Next.js version: $NEXT_VERSION"
          if [[ "$NEXT_VERSION" =~ ^15\.[0-4]\. ]] || [[ "$NEXT_VERSION" =~ ^15\.5\.[0-6]$ ]]; then
            echo "âŒ VULNERABLE Next.js version detected: $NEXT_VERSION"
            exit 1
          fi
          echo "âœ… Next.js version $NEXT_VERSION is patched"

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:production-${{ github.sha }}
            ${{ env.DOCKER_IMAGE }}:production-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_BACKEND_API_URL=${{ env.BACKEND_URL }}
            NODE_ENV=production

      - name: ðŸš€ Deploy to Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DROPLET_HOST }}
          username: ${{ env.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          script_stop: true
          script: |
            set -euo pipefail
            
            IMAGE="${{ env.DOCKER_IMAGE }}:production-latest"
            CONTAINER="${{ env.CONTAINER_NAME }}"
            PREVIOUS_IMAGE=""
            
            echo "ðŸš€ Starting production deployment..."
            
            if docker inspect "$CONTAINER" &>/dev/null; then
              PREVIOUS_IMAGE=$(docker inspect --format='{{.Config.Image}}' "$CONTAINER" 2>/dev/null || true)
              echo "ðŸ“Œ Previous image: $PREVIOUS_IMAGE"
            fi
            
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker pull "$IMAGE"
            
            docker network create ${{ env.DOCKER_NETWORK }} 2>/dev/null || true
            
            docker stop "$CONTAINER" 2>/dev/null || true
            docker rm "$CONTAINER" 2>/dev/null || true
            
            echo "â†’ Starting new container (network-only, no port exposure)..."
            docker run -d \
              --name "$CONTAINER" \
              --network ${{ env.DOCKER_NETWORK }} \
              -e NODE_ENV=production \
              --restart unless-stopped \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              --memory=512m \
              --cpus=1 \
              "$IMAGE"
            
            echo "â³ Waiting for Next.js to be ready..."
            MAX_RETRIES=24
            RETRY_INTERVAL=5
            
            for i in $(seq 1 $MAX_RETRIES); do
              if docker logs "$CONTAINER" 2>&1 | grep -q "Ready in"; then
                echo "âœ… Health check passed on attempt $i"
                break
              fi
              
              if [ $i -eq $MAX_RETRIES ]; then
                echo "âŒ Health check failed after $MAX_RETRIES attempts"
                docker logs --tail 100 "$CONTAINER"
                
                if [ -n "$PREVIOUS_IMAGE" ] && [ "$PREVIOUS_IMAGE" != "$IMAGE" ]; then
                  echo "ðŸ”„ Rolling back to $PREVIOUS_IMAGE"
                  docker stop "$CONTAINER" 2>/dev/null || true
                  docker rm "$CONTAINER" 2>/dev/null || true
                  docker run -d \
                    --name "$CONTAINER" \
                    --network ${{ env.DOCKER_NETWORK }} \
                    -e NODE_ENV=production \
                    --restart unless-stopped \
                    "$PREVIOUS_IMAGE"
                  echo "âš ï¸ Rolled back to previous version"
                fi
                exit 1
              fi
              
              echo "Attempt $i/$MAX_RETRIES: Next.js not ready yet, retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            done
            
            docker image prune -f
            echo "ðŸŽ‰ Production deployment completed successfully"

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Network:** komuu (internal only)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.DOCKER_IMAGE }}:production-latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY