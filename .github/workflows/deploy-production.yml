name: üöÄ Deploy to Production

on:
  push:
    branches: [production]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/komuu-frontend
  DROPLET_HOST: ${{ secrets.DROPLET_HOST }}
  DROPLET_USER: ${{ secrets.DROPLET_USER }}
  CONTAINER_NAME: nextjs-production
  APP_PORT: 3001
  BACKEND_URL: https://api.komuu.com/api/v1/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:production-${{ github.sha }}
            ${{ env.DOCKER_IMAGE }}:production-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_BACKEND_API_URL=${{ env.BACKEND_URL }}
            NODE_ENV=production

      - name: üöÄ Deploy to Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DROPLET_HOST }}
          username: ${{ env.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üöÄ Starting production deployment..."

            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker pull ${{ env.DOCKER_IMAGE }}:production-latest

            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              -p ${{ env.APP_PORT }}:3000 \
              -e NODE_ENV=production \
              -e NEXT_PUBLIC_BACKEND_API_URL=${{ env.BACKEND_URL }} \
              --restart unless-stopped \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              ${{ env.DOCKER_IMAGE }}:production-latest

            sleep 10

            if curl -f http://localhost:${{ env.APP_PORT }} > /dev/null 2>&1; then
              echo "‚úÖ Deployment successful"
            else
              echo "‚ùå Health check failed"
              docker logs --tail 50 ${{ env.CONTAINER_NAME }}
              exit 1
            fi

            docker image prune -f